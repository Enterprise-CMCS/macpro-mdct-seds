service: database

frameworkVersion: "2"

plugins:
  - serverless-dynamodb-local
  - serverless-stack-termination-protection
  - serverless-disable-functions

custom:
  stage: ${opt:stage, self:provider.stage}
  region: ${opt:region, self:provider.region}
  iamPath: ${ssm:/configuration/${self:custom.stage}/iam/path~true, ssm:/configuration/default/iam/path~true, "/"}
  iamPermissionsBoundaryPolicy: ${ssm:/configuration/${self:custom.stage}/iam/permissionsBoundaryPolicy~true, ssm:/configuration/default/iam/permissionsBoundaryPolicy~true, ""}
  vpcId: ${ssm:/configuration/${self:custom.stage}/vpc/id~true, ssm:/configuration/default/vpc/id~true}
  privateSubnets:
    - ${ssm:/configuration/${self:custom.stage}/vpc/subnets/private/a/id~true, ssm:/configuration/default/vpc/subnets/private/a/id~true}
    - ${ssm:/configuration/${self:custom.stage}/vpc/subnets/private/b/id~true, ssm:/configuration/default/vpc/subnets/private/b/id~true}
    - ${ssm:/configuration/${self:custom.stage}/vpc/subnets/private/c/id~true, ssm:/configuration/default/vpc/subnets/private/c/id~true}
  serverlessTerminationProtection:
    stages: # This is a list of common names for important envs that should not be destroyed.  You can remove the stage names your project doesn't use; this list is meant to be inclusive.
      - master
      - val
      - production
      - develop
      - main
      - impl
      - val
      - prod
  backupsEnabled:
    master: true #these should match the branch names
    val: true
    prod: true
  scripts:
    hooks:
      deploy:finalize: |
        serverless invoke --stage ${self:custom.stage} --function backupDynamo
  dynamodb:
    stages:
      - local
      - master
    start:
      port: 8000
      inMemory: true
      migrate: true
      seed: true
    seed:
      domain:
        sources:
          - table: ${self:custom.stage}-forms
            sources: [../../src/database/initial_data_load/forms.json]
          - table: ${self:custom.stage}-age-ranges
            sources: [../../src/database/initial_data_load/age_ranges.json]
          - table: ${self:custom.stage}-status
            sources: [../../src/database/initial_data_load/status.json]
          - table: ${self:custom.stage}-states
            sources: [../../src/database/initial_data_load/states.json]
          - table: ${self:custom.stage}-state-forms
            sources: [../../src/database/initial_data_load/state_forms.json]
          - table: ${self:custom.stage}-form-questions
            sources:
              [
                ../../src/database/initial_data_load/21E.json,
                ../../src/database/initial_data_load/21E_2020.json,
                ../../src/database/initial_data_load/64_21E.json,
                ../../src/database/initial_data_load/GenderRaceEthnicity.json,
                ../../src/database/initial_data_load/21PW.json,
                ../../src/database/initial_data_load/21PW_2020.json,
                ../../src/database/initial_data_load/64EC.json,
              ]
          - table: ${self:custom.stage}-form-answers
            sources:
              [
                ../../src/database/initial_data_load/form_answers_21E_AL.json,
                ../../src/database/initial_data_load/form_answers_21E_MD.json,
                ../../src/database/initial_data_load/form_answers_21E_PA.json,
                ../../src/database/initial_data_load/form_answers_64EC_AL.json,
                ../../src/database/initial_data_load/form_answers_64EC_MD.json,
                ../../src/database/initial_data_load/form_answers_64EC_PA.json,
                ../../src/database/initial_data_load/form_answers_64_21E_AL.json,
                ../../src/database/initial_data_load/form_answers_64_21E_MD.json,
                ../../src/database/initial_data_load/form_answers_64_21E_PA.json,
                ../../src/database/initial_data_load/form_answers_GRE_AL.json,
                ../../src/database/initial_data_load/form_answers_GRE_MD.json,
                ../../src/database/initial_data_load/form_answers_GRE_PA.json,
                ../../src/database/initial_data_load/form_answers_21PW_PA.json,
                ../../src/database/initial_data_load/form_answers_21PW_MD.json,
                ../../src/database/initial_data_load/form_answers_21PW_AL.json,
                ../../src/database/initial_data_load/form_answers_21PW_PA_Q4.json,
                ../../src/database/initial_data_load/form_answers_21PW_PA_Q3.json,
                ../../src/database/initial_data_load/form_answers_21E_AL_Q4.json,
              ]
          - table: ${self:custom.stage}-auth-user
            sources: [../../src/database/initial_data_load/auth_user.json]
          - table: ${self:custom.stage}-auth-user-roles
            sources: [../../src/database/initial_data_load/auth_user_roles.json]
  functions:
    backupDynamo:
      handler: handlers/backupDynamo.handler
      enabled: ${self:custom.backupsEnabled.${self:custom.stage}, "false"}
      role: LambdaConfigureRole
      environment:
        branchName: ${self:custom.stage}
        backupRetention: ${self:custom.stage}/dynamo/backup/retention
      maximumRetryAttempts: 2
      timeout: 120
      vpc:
        securityGroupIds:
          - Ref: LambdaConfigureSecurityGroup
        subnetIds: ${self:custom.privateSubnets}
      events:
        - schedule: cron(0 1 ? * MON-FRI *)

provider:
  name: aws
  runtime: nodejs12.x
  region: us-east-1
  versionFunctions: true

resources:
  Conditions:
    CreatePermissionsBoundary:
      Fn::Not:
        - Fn::Equals:
            - ""
            - ${self:custom.iamPermissionsBoundaryPolicy}
  Resources:
    LambdaConfigureSecurityGroup:
      Type: AWS::EC2::SecurityGroup
      Properties:
        GroupDescription: Security Group for configuring the connector.
        VpcId: ${self:custom.vpcId}
    LambdaConfigureRole:
      Type: "AWS::IAM::Role"
      Properties:
        AssumeRolePolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: "Allow"
              Principal:
                Service: "lambda.amazonaws.com"
              Action: "sts:AssumeRole"
        Path: ${self:custom.iamPath}
        PermissionsBoundary:
          Fn::If:
            - CreatePermissionsBoundary
            - !Sub arn:aws:iam::${AWS::AccountId}:policy${self:custom.iamPermissionsBoundaryPolicy}
            - Ref: AWS::NoValue
        Policies:
          - PolicyName: "RDSRolePolicy"
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: "Allow"
                  Action:
                    - rds-db:connect
                  Resource: "arn:aws:rds-db:*:dbuser:*/*"
    AgeRangesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.stage}-age-ranges
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        AttributeDefinitions:
          - AttributeName: ageRange
            AttributeType: S
        KeySchema:
          - AttributeName: ageRange
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST # Set the capacity to auto-scale
    FormAnswersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.stage}-form-answers
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        AttributeDefinitions:
          - AttributeName: answer_entry
            AttributeType: S
        KeySchema:
          - AttributeName: answer_entry
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST # Set the capacity to auto-scale
    FormQuestionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.stage}-form-questions
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        AttributeDefinitions:
          - AttributeName: question
            AttributeType: S
        KeySchema:
          - AttributeName: question
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST # Set the capacity to auto-scale
    FormsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.stage}-forms
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        AttributeDefinitions:
          - AttributeName: form
            AttributeType: S
        KeySchema:
          - AttributeName: form
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST # Set the capacity to auto-scale
    StateFormsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.stage}-state-forms
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        AttributeDefinitions:
          - AttributeName: state_form
            AttributeType: S
        KeySchema:
          - AttributeName: state_form
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST # Set the capacity to auto-scale
    StatesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.stage}-states
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        AttributeDefinitions:
          - AttributeName: state_id
            AttributeType: S
        KeySchema:
          - AttributeName: state_id
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST # Set the capacity to auto-scale
    StatusTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.stage}-status
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        AttributeDefinitions:
          - AttributeName: status
            AttributeType: S
        KeySchema:
          - AttributeName: status
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST # Set the capacity to auto-scale
    AuthUserTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.stage}-auth-user
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST # Set the capacity to auto-scale
    AuthUserRolesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.stage}-auth-user-roles
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST # Set the capacity to auto-scale
    AuthJobCodesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.stage}-auth-user-job-codes
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        AttributeDefinitions:
          - AttributeName: job-code
            AttributeType: S
        KeySchema:
          - AttributeName: job-code
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST # Set the capacity to auto-scale
    AuthUserStatesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.stage}-auth-user-states
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST # Set the capacity to auto-scale
  Outputs:
    AgeRangesTableName:
      Value: !Ref AgeRangesTable
    AgeRangesTableArn:
      Value: !GetAtt AgeRangesTable.Arn
    AgeRangesTableStreamArn:
      Value: !GetAtt AgeRangesTable.StreamArn
    FormAnswersTableName:
      Value: !Ref FormAnswersTable
    FormAnswersTableArn:
      Value: !GetAtt FormAnswersTable.Arn
    FormAnswersTableStreamArn:
      Value: !GetAtt FormAnswersTable.StreamArn
    FormQuestionsTableName:
      Value: !Ref FormQuestionsTable
    FormQuestionsTableArn:
      Value: !GetAtt FormQuestionsTable.Arn
    FormQuestionsTableStreamArn:
      Value: !GetAtt FormQuestionsTable.StreamArn
    FormsTableName:
      Value: !Ref FormsTable
    FormsTableArn:
      Value: !GetAtt FormsTable.Arn
    FormsTableStreamArn:
      Value: !GetAtt FormsTable.StreamArn
    StateFormsTableName:
      Value: !Ref StateFormsTable
    StateFormsTableArn:
      Value: !GetAtt StateFormsTable.Arn
    StateFormsTableStreamArn:
      Value: !GetAtt StateFormsTable.StreamArn
    StatesTableName:
      Value: !Ref StatesTable
    StatesTableArn:
      Value: !GetAtt StatesTable.Arn
    StateTableStreaArn:
      Value: !GetAtt StatesTable.StreamArn
    StatusTableName:
      Value: !Ref StatusTable
    StatusTableArn:
      Value: !GetAtt StatusTable.Arn
    StatusTableStreamArn:
      Value: !GetAtt StatusTable.StreamArn
    AuthUserTableName:
      Value: !Ref AuthUserTable
    AuthUserTableArn:
      Value: !GetAtt AuthUserTable.Arn
    AuthUserTableStreamArn:
      Value: !GetAtt AuthUserTable.StreamArn
    AuthUserRolesTableName:
      Value: !Ref AuthUserRolesTable
    AuthUserRolesTableArn:
      Value: !GetAtt AuthUserRolesTable.Arn
    AuthUserRolesTableStreamArn:
      Value: !GetAtt AuthUserRolesTable.StreamArn
    AuthJobCodesTableName:
      Value: !Ref AuthJobCodesTable
    AuthJobCodesTableArn:
      Value: !GetAtt AuthJobCodesTable.Arn
    AuthJobCodesTableStreamArn:
      Value: !GetAtt AuthJobCodesTable.StreamArn
    AuthUserStatesTableName:
      Value: !Ref AuthJobCodesTable
    AuthUserStatesTableArn:
      Value: !GetAtt AuthJobCodesTable.Arn
    AuthUserStatesTableStreamArn:
      Value: !GetAtt AuthJobCodesTable.StreamArn

    Region:
      Value: !Sub ${AWS::Region}
